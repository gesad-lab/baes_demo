{#
Database Schema Template - PostgreSQL/SQLite CREATE TABLE for Standard CRUD
Feature: 001-performance-optimization / US1: Template-Based Generation

Constitutional Compliance:
- Primary keys with auto-increment (identity column)
- Indexes on frequently queried columns
- Constraints for data integrity
- Timestamps for observability (created_at, updated_at)

Context variables:
- entity_name (str): Business entity name (e.g., "Student", "Course")
- attributes (dict): {attribute_name: type_string}
- indexes (list, optional): Additional indexes beyond primary key
- constraints (list, optional): Custom CHECK constraints
#}
-- {{ entity_name }} Schema - Database Table Definition
-- Generated using BAES Template System for standard CRUD operations
-- Feature: 001-performance-optimization (Template-based generation)
-- Constitutional Compliance: Primary keys, Indexes, Constraints, Timestamps

-- Drop table if exists (development/testing only)
DROP TABLE IF EXISTS {{ entity_name | snake_case }} CASCADE;

-- Create {{ entity_name }} table
CREATE TABLE {{ entity_name | snake_case }} (
    -- Primary key (auto-increment)
    id SERIAL PRIMARY KEY,

    -- Entity attributes
{%- for attr_name, attr_type in attributes.items() %}
{%- if attr_type | python_type == 'str' %}
    {{ attr_name }} VARCHAR(255) NOT NULL,
{%- elif attr_type | python_type == 'int' %}
    {{ attr_name }} INTEGER NOT NULL,
{%- elif attr_type | python_type == 'float' %}
    {{ attr_name }} REAL NOT NULL,
{%- elif attr_type | python_type == 'bool' %}
    {{ attr_name }} BOOLEAN NOT NULL DEFAULT FALSE,
{%- elif attr_type | python_type == 'datetime.date' %}
    {{ attr_name }} DATE NOT NULL,
{%- elif attr_type | python_type == 'datetime.datetime' %}
    {{ attr_name }} TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
{%- else %}
    {{ attr_name }} TEXT NOT NULL,
{%- endif %}
{%- endfor %}

    -- Audit fields (constitutional requirement: observability)
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes for performance
CREATE INDEX idx_{{ entity_name | snake_case }}_id ON {{ entity_name | snake_case }}(id);
CREATE INDEX idx_{{ entity_name | snake_case }}_created_at ON {{ entity_name | snake_case }}(created_at);

{%- if indexes %}
{%- for index in indexes %}
CREATE INDEX idx_{{ entity_name | snake_case }}_{{ index }} ON {{ entity_name | snake_case }}({{ index }});
{%- endfor %}
{%- endif %}

-- Add constraints for data integrity
{%- if constraints %}
{%- for constraint in constraints %}
ALTER TABLE {{ entity_name | snake_case }} ADD CONSTRAINT {{ constraint.name }} {{ constraint.definition }};
{%- endfor %}
{%- endif %}

-- Add comment for documentation
COMMENT ON TABLE {{ entity_name | snake_case }} IS '{{ entity_name }} entity - Standard CRUD table generated by BAES Template System';

-- Trigger for automatic updated_at timestamp (PostgreSQL)
CREATE OR REPLACE FUNCTION update_{{ entity_name | snake_case }}_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_{{ entity_name | snake_case }}_timestamp
BEFORE UPDATE ON {{ entity_name | snake_case }}
FOR EACH ROW
EXECUTE FUNCTION update_{{ entity_name | snake_case }}_timestamp();
